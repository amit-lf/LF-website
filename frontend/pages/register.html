<!doctype html>
<html lang="en">
  
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="../assets/favicon.ico">
    <title>Legal Forensics - Register</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
    <link href="../styles/custom.css" rel="stylesheet">
 <link rel="shortcut icon" href="../assets/favicon.ico" type="image/x-icon">
    <script>
        const LOG_LEVELS = { DEBUG: 0, INFO: 1, WARN: 2, ERROR: 3 };
        const CURRENT_LOG_LEVEL = LOG_LEVELS.INFO;
        
        function log(level, message, data = null) {
            if (level >= CURRENT_LOG_LEVEL) {
                const timestamp = new Date().toISOString();
                const levelName = Object.keys(LOG_LEVELS)[level];
                console.log(`[${timestamp}] [${levelName}] ${message}`, data || '');
            }
        }
        
        document.addEventListener('keydown', e => {
            if (e.key === 'F12') {
                e.preventDefault();
                log(LOG_LEVELS.WARN, 'F12 key blocked');
                return false;
            }
        });
        
        console.log('%cSecurity Notice', 'color: orange; font-size: 20px; font-weight: bold;');
        console.log('%cThis is a protected registration form. All actions are logged.', 'color: orange; font-size: 14px;');
    </script>

    <style>
      .email-status {
        font-size: 0.875rem;
        margin-top: 0.25rem;
      }
      
      .email-status.validating {
        color: #6c757d;
      }
      
      .email-status.valid {
        color: #198754;
      }
      
      .email-status.invalid {
        color: #dc3545;
      }
      
      .spinner-border-sm {
        width: 1rem;
        height: 1rem;
      }
      
      .form-control.is-valid {
        border-color: #198754;
        box-shadow: 0 0 0 0.25rem rgba(25, 135, 84, 0.25);
      }
      
      .form-control.is-invalid {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
      }
      
      .api-info {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-bottom: 1rem;
        font-size: 0.875rem;
      }
    </style>
  </head>
  <body>
            
         
<div class="container">
   <header class="d-flex flex-wrap align-items-center justify-content-center justify-content-md-between py-3 mb-4 ">
     
       <div class="col-md-3 mb-2 mb-md-0"> <a href="../../index.html" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto link-body-emphasis text-decoration-none"><img  src="../assets/images/logo/Logo.png" /></a> </div>
     
      <div class="col-md-3 text-end"><a href="login.html" class="btn btn-outline-primary me-2">Login</a> </div>

  </header>
</div>

<div class="col-lg-3 col-sm-6 mx-auto">

           <div class="px-4 pt-5 my-5 border">

                    <div class="container px-5"> 
                                  <form id="registerForm" class="needs-validation" novalidate>
                                                    <h5>Register</h5>

                            <div class="form-group">
                                  <span class="text-gray">our reimagined contract intelligence.
                                  </span> 
                            </div>        
                            <br/>
                                                                          
                          <div class="form-group">
                                
                                <label for="validationFname" class="form-label">First name</label>
                                         <input type="text" class="form-control" id="validationFname"  placeholder="Enter your First Name" required>
                               <div class="invalid-feedback">
                                     First Name is required.
                               </div>
                                                                                              
                          </div>
                          <br/>
                               <div class="form-group">
                                
                                <label for="validationLname" class="form-label">Last name</label>
                                         <input type="text" class="form-control" id="validationLname"  placeholder="Enter your Last Name" required>
                               <div class="invalid-feedback">
                                     Last Name is required.
                               </div>
                                                                                              
                          </div>
                            <br/>
                              <div class="form-group">
                            
                              <label for="validationEmail">Email address</label>
                         
                              <input type="email" class="form-control" id="validationEmail" aria-describedby="emailHelp" placeholder="Enter your email" required>
                             
                                   <div class="invalid-feedback">
                                   Invalid Email address.
                               </div>
                                         
                                   <div id="emailStatus" class="email-status"></div>

                           </div>
                       
                          <br/>
                          <div class="d-grid gap-2">
                           <button type="submit" class="btn btn-primary" id="submitBtn" disabled>Submit</button>
                           </div>
                           </form>
                           <br/>
                           <br/>
                       </div>

         </div> 
</div>  
   
<div class="px-4 pt-5 my-5 text-center border-top">

  <span> © 2025 Legal Forensics. All Rights Reserved</span>

</div>

<script>
class EmailVerifier {
  constructor() {
    this.emailInput = document.getElementById('validationEmail');
    this.emailStatus = document.getElementById('emailStatus');
    this.submitBtn = document.getElementById('submitBtn');
    this.form = document.getElementById('registerForm');
    this.debounceTimer = null;
    
    log(LOG_LEVELS.INFO, 'EmailVerifier initialized');
    this.init();
  }
  
  init() {
    // Add input event listener for real-time validation
    this.emailInput.addEventListener('input', (e) => {
      this.clearStatus();
      this.debounceValidation(e.target.value);
    });
    
    // Add form submit handler
    this.form.addEventListener('submit', (e) => {
      e.preventDefault();
      this.handleSubmit();
    });
    
    // Add blur event for immediate validation when user leaves email field
    this.emailInput.addEventListener('blur', (e) => {
      if (e.target.value.trim()) {
        this.validateEmail(e.target.value);
      }
    });
  }
  
  debounceValidation(email) {
    clearTimeout(this.debounceTimer);
    this.debounceTimer = setTimeout(() => {
      if (email.trim() && this.isValidEmailFormat(email)) {
        this.validateEmail(email);
      }
    }, 2000); // Wait 2 seconds after user stops typing (increased from 500ms)
  }
  
  isValidEmailFormat(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  }
  
  clearStatus() {
    this.emailStatus.innerHTML = '';
    this.emailStatus.className = 'email-status';
    this.emailInput.classList.remove('is-valid', 'is-invalid');
  }
  
  showStatus(message, type) {
    this.emailStatus.innerHTML = message;
    this.emailStatus.className = `email-status ${type}`;
    
    
    if (type === 'valid') {
      this.emailInput.classList.add('is-valid');
      this.emailInput.classList.remove('is-invalid');
      this.submitBtn.disabled = false;
    } else if (type === 'invalid') {
      this.emailInput.classList.add('is-invalid');
      this.emailInput.classList.remove('is-valid');
      this.submitBtn.disabled = true;
    }
  }
  
  async validateEmail(email) {
    if (!this.isValidEmailFormat(email)) {
      this.showStatus('Please enter a valid email format', 'invalid');
      return;
    }
    
    log(LOG_LEVELS.INFO, 'Starting email verification', { email: email.substring(0, 10) + '***' });
    this.showStatus('<span class="spinner-border spinner-border-sm me-2"></span>Verifying email...', 'validating');
    
    try {
      const startTime = Date.now();
      
      log(LOG_LEVELS.INFO, 'Making API request to verify email', { 
        email: email.substring(0, 10) + '***',
        url: 'https://legal-forensics-api-dev-vish.hebbarvcorning.workers.dev/api/verify-email'
      });
      
      const response = await fetch('https://legal-forensics-api-dev-vish.hebbarvcorning.workers.dev/api/verify-email', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email })
      });
      
      const responseTime = Date.now() - startTime;
      log(LOG_LEVELS.INFO, 'Email verification response received', { 
        status: response.status, 
        responseTime: `${responseTime}ms`,
        email: email.substring(0, 10) + '***'
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        log(LOG_LEVELS.ERROR, 'Email verification failed', { 
          status: response.status,
          error: errorText,
          email: email.substring(0, 10) + '***'
        });
        throw new Error(`Verification service unavailable (${response.status}: ${response.statusText})`);
      }
      
      const result = await response.json();
      
      if (result.fallback) {
        // Do NOT show green success on fallback; keep disabled and warn
        log(LOG_LEVELS.WARN, 'Hunter verification fallback used', {
          email: email.substring(0, 10) + '***',
          message: result.message
        });
        this.showStatus('⚠️ Verification service unavailable. Try again later.', 'invalid');
      } else if (result.valid || result.status === 'valid' || result.status === 'accept_all') {
        // Accept multiple Hunter.io statuses as valid
        log(LOG_LEVELS.INFO, 'Email verification successful', { 
          email: email.substring(0, 10) + '***',
          score: result.score,
          status: result.status
        });
        this.showStatus('✓ Email verified successfully', 'valid');
      } else {
        log(LOG_LEVELS.WARN, 'Email verification failed', { 
          email: email.substring(0, 10) + '***',
          score: result.score,
          status: result.status
        });
        this.showStatus('✗ Email appears to be invalid or disposable', 'invalid');
      }
      
    } catch (error) {
      log(LOG_LEVELS.ERROR, 'Email verification error', { 
        error: error.message,
        email: email.substring(0, 10) + '***',
        errorType: error.name
      });
      
      // Fallback: Do not show green success; keep as warning/invalid
      this.showStatus('⚠️ Verification service unavailable. Please submit later.', 'invalid');
    }
  }
  
  async handleSubmit() {
    // Final validation before submission
    const email = this.emailInput.value.trim();
    const firstName = document.getElementById('validationFname').value.trim();
    const lastName = document.getElementById('validationLname').value.trim();
    
    if (!firstName || !lastName || !email) {
      log(LOG_LEVELS.WARN, 'Form validation failed - missing fields');
      alert('Please fill in all required fields');
      return;
    }
    
    if (!this.isValidEmailFormat(email)) {
      log(LOG_LEVELS.WARN, 'Form validation failed - invalid email');
      alert('Please enter a valid email address');
      return;
    }
    
    // If we have a valid email status, proceed
    if (this.emailStatus.classList.contains('valid') || this.emailInput.classList.contains('is-valid')) {
      log(LOG_LEVELS.INFO, 'Form submission started', { 
        email: email.substring(0, 10) + '***',
        firstName: firstName.substring(0, 1) + '***',
        lastName: lastName.substring(0, 1) + '***'
      });
      
      try {
        const startTime = Date.now();
        
        // Store user data
        const response = await fetch('https://legal-forensics-api-dev-vish.hebbarvcorning.workers.dev/api/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            firstName: firstName,
            lastName: lastName,
            email: email
          })
        });
        
        const responseTime = Date.now() - startTime;
        log(LOG_LEVELS.INFO, 'Registration response received', { 
          status: response.status, 
          responseTime: `${responseTime}ms` 
        });
        
        if (response.ok) {
          const result = await response.json();
          log(LOG_LEVELS.INFO, 'User registered successfully', { 
            userId: result.data?.userId,
            email: email.substring(0, 10) + '***'
          });
          
          // Store user data in sessionStorage for welcome page
          sessionStorage.setItem('userData', JSON.stringify({
            firstName: firstName,
            lastName: lastName,
            email: email
          }));
          
          // Redirect to welcome page
          window.location.href = 'welcome.html';
        } else {
          const error = await response.json();
          log(LOG_LEVELS.ERROR, 'Registration failed', { error: error.error, status: response.status });
          
          if (response.status === 409) {
            // User already exists - redirect to login
            alert('An account with this email already exists. Redirecting to login page.');
            window.location.href = 'login.html';
          } else {
            alert('Registration failed: ' + error.error);
          }
        }
      } catch (error) {
        log(LOG_LEVELS.ERROR, 'Registration error', { 
          error: error.message,
          stack: error.stack,
          email: email.substring(0, 10) + '***'
        });
        
        if (error.message.includes('NetworkError') || error.message.includes('fetch')) {
          alert('Network error. Please check your internet connection and try again.');
        } else {
          alert('Registration failed. Please try again.');
        }
      }
    } else {
      log(LOG_LEVELS.WARN, 'Form submission blocked - email not verified');
      alert('Please ensure your email is valid before submitting');
    }
  }
}

// Initialize email verifier when page loads
document.addEventListener('DOMContentLoaded', () => {
  log(LOG_LEVELS.INFO, 'Registration page initialized', { 
    userAgent: navigator.userAgent,
    timestamp: new Date().toISOString()
  });
  
  new EmailVerifier();
  
  // Global error handling
  window.addEventListener('error', function(e) {
    log(LOG_LEVELS.ERROR, 'JavaScript error', { 
      message: e.message,
      filename: e.filename,
      lineno: e.lineno,
      colno: e.colno,
      stack: e.error?.stack
    });
  });
  
  window.addEventListener('unhandledrejection', function(e) {
    log(LOG_LEVELS.ERROR, 'Unhandled promise rejection', { 
      reason: e.reason,
      stack: e.reason?.stack
    });
  });
});

// Bootstrap validation (keeping existing functionality)
(() => {
  'use strict'

  // Fetch all the forms we want to apply custom Bootstrap validation styles to
  const forms = document.querySelectorAll('.needs-validation')

  // Loop over them and prevent submission
  Array.from(forms).forEach(form => {
    form.addEventListener('submit', event => {
      if (!form.checkValidity()) {
        event.preventDefault()
        event.stopPropagation()
      }

      form.classList.add('was-validated')
    }, false)
  })
})()
</script>

  </body>
</html>
