<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="../assets/favicon.ico">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
    <link href="../styles/custom.css" rel="stylesheet">
     <link rel="shortcut icon" href="../assets/favicon.ico" type="image/x-icon">
    <!-- Enhanced Security and Anti-DevTools Protection -->
    <script>
        // Anti-devtools and code protection (Minimal - allow console access!)
        (function() {
            'use strict';
            
            // Only block F12 key (allow right-click and other devtools)
            document.addEventListener('keydown', e => {
                if (e.key === 'F12') {
                    e.preventDefault();
                    console.log('[WARN] F12 key blocked');
                    return false;
                }
            });
            
            // Console warning (but allow access!)
            console.log('%cSecurity Notice', 'color: orange; font-size: 20px; font-weight: bold;');
            console.log('%cThis is a protected admin interface. All actions are logged.', 'color: orange; font-size: 14px;');
            
        })();
    </script>
    
    <style>
        :root {
            --primary-color: #e3bb9b;
            --secondary-color: #d4a574;
            --border-color: #dee2e6;
            --text-primary: #212529;
            --text-secondary: #6c757d;
        }

        body {
            background: #f8f9fa;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px;
        }

        .auth-overlay {
            position: fixed;
            top: 0.5;
            left: 0.5;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .auth-modal {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            max-width: 400px;
            width: 90%;
        }

        .dashboard-container {
            display: none;
        }

        .navbar {
            background: white;
            border-bottom: 1px solid var(--border-color);
            padding: 0.5rem 0;
        }

        .navbar-brand {
            font-weight: 600;
            color: var(--text-primary) !important;
            font-size: 1rem;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .logo-section {
            display: flex;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .dashboard-title {
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            margin: 0;
        }

        .navbar-nav {
            display: flex;
            align-items: center;
        }

        .admin-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            margin-right: 1rem;
        }

        .admin-text {
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
        }

        .main-content {
            padding: 1.5rem 2rem 2rem 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
            margin-top: 1rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.8rem;
            text-transform: uppercase;
        }

        .data-table {
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .table-header {
            background: #f8f9fa;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .table-title {
            margin: 0;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1rem;
        }

        .table-subtitle {
            color: var(--text-secondary);
            margin: 0.25rem 0 0 0;
            font-size: 0.8rem;
        }

        .table {
            margin: 0;
            font-size: 0.9rem;
        }

        .table th {
            border: none;
            padding: 0.75rem 1rem;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        .table td {
            border: none;
            padding: 0.75rem 1rem;
            vertical-align: middle;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .status-verified {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
        }

        .status-pending {
            background: rgba(255, 193, 7, 0.1);
            color: #ffc107;
        }

        .btn-primary-custom {
            background: var(--primary-color);
            border: var(--primary-color);
            border-radius: 6px;
            padding: 0.5rem 1rem;
            font-weight: 500;
            font-size: 0.8rem;
        }

        .btn-primary-custom:hover {
            background: var(--secondary-color);
            border: var(--secondary-color);
        }

        .btn-outline-custom {
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            border-radius: 6px;
            padding: 0.5rem 1rem;
            font-weight: 500;
            font-size: 0.8rem;
        }

        .btn-outline-custom:hover {
            background: var(--primary-color);
            color: white;
        }

        .search-box {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            width: 100%;
            max-width: 250px;
            font-size: 0.8rem;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .loading-spinner {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--border-color);
        }

        .logo-img {
            height: 40px;
            width: auto;
        }
        
        /* Security warning styles */
        .security-warning {
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.3);
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 1rem;
            font-size: 0.8rem;
            color: #dc3545;
        }
    </style>
</head>
<body>
    <!-- Enhanced Authentication Overlay -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-modal">
            <h5 class="text-center mb-3">üîí Admin Access Required</h5>
            <div class="security-warning">
                <strong>‚ö†Ô∏è Security Notice:</strong> This is a protected admin interface. All access attempts are logged and monitored.
            </div>
            <div class="mb-3">
                <label class="form-label">Admin Password</label>
                <input type="password" id="adminPassword" class="form-control" placeholder="Enter admin password" autocomplete="off">
            </div>
            <button class="btn btn-primary-custom w-100" onclick="authenticate()">Access Dashboard</button>
            <div class="text-center mt-2">
                <small class="text-muted">Contact system administrator for access</small>
            </div>
        </div>
    </div>

    <!-- Enhanced Dashboard Container -->
    <div id="dashboardContainer" class="dashboard-container">
        <!-- Enhanced Navigation Bar -->
        <nav class="navbar">
            <div class="container">
                <a class="navbar-brand" href="../../index.html">
                    <img src="../assets/images/logo/Logo.png" alt="Legal Forensics" class="logo-img me-2">
                    <div class="logo-section">
                        <!-- <h6 class="dashboard-title">Legal Forensics</h6> -->
                        <p class="dashboard-title">Admin Dashboard</p>
                    </div>
                </a>
                <div class="navbar-nav ms-auto">
                    <div class="admin-info">
                        <span class="admin-text">Administrator</span>
                        <button class="btn btn-outline-custom btn-sm" onclick="logout()">Logout</button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Enhanced Main Content -->
        <div class="main-content">
            <div class="container">
                <!-- Enhanced Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalUsers">-</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="verifiedEmails">-</div>
                        <div class="stat-label">Verified Emails</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="todayRegistrations">-</div>
                        <div class="stat-label">Today's Registrations</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgHunterScore">-</div>
                        <div class="stat-label">Avg Hunter Score</div>
                    </div>
                </div>

                <!-- Enhanced Data Table -->
                <div class="data-table">
                    <div class="table-header">
                        <h5 class="table-title">Registered Users</h5>
                        <p class="table-subtitle">Manage and monitor user registrations</p>
                    </div>
                    
                    <div class="p-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="d-flex gap-2">
                                <input type="text" id="searchBox" class="search-box" placeholder="Search users..." oninput="filterUsers()">
                                <button class="btn btn-primary-custom" onclick="loadUsers()">Refresh</button>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary-custom" onclick="downloadCSV()">Export CSV</button>
                                <button class="btn btn-outline-custom" onclick="addUser()">Add User</button>
                            </div>
                        </div>
                        
                        <div id="usersTableContainer">
                            <div class="loading-spinner">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Footer -->
        <div class="px-4 pt-5 my-5 text-center border-top">
            <span>¬© 2025 Legal Forensics. All Rights Reserved</span>
        </div>
    </div>

    <!-- Enhanced JavaScript with Security and Logging -->
    <script>
        // Enhanced logging system
        const LOG_LEVELS = {
            DEBUG: 0,
            INFO: 1,
            WARN: 2,
            ERROR: 3
        };
        
        const CURRENT_LOG_LEVEL = LOG_LEVELS.INFO;
        
        function log(level, message, data = null) {
            if (level >= CURRENT_LOG_LEVEL) {
                const timestamp = new Date().toISOString();
                const levelName = Object.keys(LOG_LEVELS)[level];
                
                console.log(`[${timestamp}] [${levelName}] ${message}`, data || '');
                
                // In production, you could send to external logging service
                // sendToLogService({ timestamp, level: levelName, message, data });
            }
        }
        
        // Enhanced authentication system
        const ADMIN_PASSWORD = 'LegalForensics2025'; // Change this in production
        const MAX_LOGIN_ATTEMPTS = 3;
        let loginAttempts = 0;
        let sessionStartTime = null;
        
        function authenticate() {
            const password = document.getElementById('adminPassword').value;
            
            log(LOG_LEVELS.INFO, 'Authentication attempt', { 
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                ipAddress: 'client-side' // Would be server-side in production
            });
            
            if (password === ADMIN_PASSWORD) {
                loginAttempts = 0;
                sessionStartTime = new Date();
                
                document.getElementById('authOverlay').style.display = 'none';
                document.getElementById('dashboardContainer').style.display = 'block';
                
                // Store session data securely
                const sessionData = {
                    authenticated: true,
                    timestamp: sessionStartTime.getTime(),
                    expires: sessionStartTime.getTime() + (8 * 60 * 60 * 1000) // 8 hours
                };
                
                try {
                    sessionStorage.setItem('adminSession', JSON.stringify(sessionData));
                } catch (e) {
                    log(LOG_LEVELS.WARN, 'Session storage failed', { error: e.message });
                }
                
                log(LOG_LEVELS.INFO, 'Authentication successful', { 
                    sessionStartTime: sessionStartTime.toISOString(),
                    userAgent: navigator.userAgent
                });
                
                loadUsers();
            } else {
                loginAttempts++;
                log(LOG_LEVELS.WARN, 'Authentication failed', { 
                    attempt: loginAttempts,
                    maxAttempts: MAX_LOGIN_ATTEMPTS,
                    userAgent: navigator.userAgent
                });
                
                if (loginAttempts >= MAX_LOGIN_ATTEMPTS) {
                    log(LOG_LEVELS.ERROR, 'Maximum login attempts exceeded', { 
                        userAgent: navigator.userAgent,
                        timestamp: new Date().toISOString()
                    });
                    
                    alert('Maximum login attempts exceeded. Access temporarily blocked.');
                    document.getElementById('adminPassword').disabled = true;
                    
                    // Re-enable after 15 minutes
                    setTimeout(() => {
                        document.getElementById('adminPassword').disabled = false;
                        loginAttempts = 0;
                    }, 15 * 60 * 1000);
                } else {
                    alert(`Invalid password. ${MAX_LOGIN_ATTEMPTS - loginAttempts} attempts remaining.`);
                }
                
                document.getElementById('adminPassword').value = '';
            }
        }
        
        function logout() {
            log(LOG_LEVELS.INFO, 'User logout', { 
                sessionDuration: sessionStartTime ? Date.now() - sessionStartTime.getTime() : 0
            });
            
            document.getElementById('authOverlay').style.display = 'flex';
            document.getElementById('dashboardContainer').style.display = 'none';
            document.getElementById('adminPassword').value = '';
            
            // Clear session data
            try {
                sessionStorage.removeItem('adminSession');
            } catch (e) {
                log(LOG_LEVELS.WARN, 'Session cleanup failed', { error: e.message });
            }
            
            sessionStartTime = null;
        }
        
        // Session validation
        function validateSession() {
            try {
                const sessionData = sessionStorage.getItem('adminSession');
                if (!sessionData) return false;
                
                const session = JSON.parse(sessionData);
                const now = Date.now();
                
                if (!session.authenticated || now > session.expires) {
                    log(LOG_LEVELS.WARN, 'Session expired or invalid', { 
                        sessionData: session,
                        currentTime: now
                    });
                    return false;
                }
                
                return true;
            } catch (e) {
                log(LOG_LEVELS.ERROR, 'Session validation error', { error: e.message });
                return false;
            }
        }
        
        // Enhanced user management
        async function loadUsers() {
            try {
                log(LOG_LEVELS.INFO, 'Loading users');
                
                                                                   const response = await fetch('https://legal-forensics-api-dev-vish.hebbarvcorning.workers.dev/api/users');
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
                }
                
                const data = await response.json();
                
                log(LOG_LEVELS.DEBUG, 'API response received', { data });
                
                // Handle KV namespace not configured error
                if (data.error && data.error.includes('Database not configured')) {
                    log(LOG_LEVELS.WARN, 'KV namespace not configured', { error: data.error });
                    document.getElementById('usersTableContainer').innerHTML = `
                        <div class="empty-state">
                            <div>‚ö†Ô∏è</div>
                            <h5>Database Not Configured</h5>
                            <p>${data.error}</p>
                            <div class="alert alert-warning">
                                <strong>Setup Required:</strong><br>
                                1. Go to Cloudflare Dashboard ‚Üí Workers & Pages ‚Üí KV<br>
                                2. Create namespace: <code>LF_USERS</code><br>
                                3. Bind to worker as: <code>LF_USERS_DATA</code><br>
                                4. Redeploy the worker
                            </div>
                            <button class="btn btn-primary-custom" onclick="loadUsers()">Retry</button>
                        </div>
                    `;
                    return;
                }
                
                if (data.success && data.data) {
                    const users = data.data.users || [];
                    const stats = data.data.stats || {};
                    
                    log(LOG_LEVELS.INFO, 'Users loaded successfully', { 
                        userCount: users.length,
                        totalUsers: stats.totalUsers || users.length
                    });
                    
                    updateStats(stats);
                    displayUsers(users);
                } else if (data.users) {
                    // Fallback for backward compatibility
                    const users = data.users || [];
                    const stats = {
                        totalUsers: users.length,
                        verifiedEmails: users.filter(u => u.emailVerified).length,
                        todayRegistrations: users.filter(u => {
                            const today = new Date().toDateString();
                            return new Date(u.registrationDate).toDateString() === today;
                        }).length,
                        avgHunterScore: users.length > 0 ? 
                            (users.reduce((sum, u) => sum + (u.hunterScore || 0), 0) / users.length).toFixed(1) : 0
                    };
                    
                    log(LOG_LEVELS.INFO, 'Users loaded with fallback stats', { 
                        userCount: users.length,
                        totalUsers: stats.totalUsers
                    });
                    
                    updateStats(stats);
                    displayUsers(users);
                } else {
                    throw new Error(data.error || 'Invalid response format');
                }
                
            } catch (error) {
                log(LOG_LEVELS.ERROR, 'Failed to load users', { 
                    error: error.message,
                    stack: error.stack
                });
                
                document.getElementById('usersTableContainer').innerHTML = `
                    <div class="empty-state">
                        <div>‚ùå</div>
                        <p>Failed to load users: ${error.message}</p>
                        <button class="btn btn-primary-custom" onclick="loadUsers()">Retry</button>
                    </div>
                `;
            }
        }
        
        function updateStats(stats) {
            // Handle missing stats gracefully
            const safeStats = {
                totalUsers: stats?.totalUsers || 0,
                verifiedEmails: stats?.verifiedEmails || 0,
                todayRegistrations: stats?.todayRegistrations || 0,
                avgHunterScore: stats?.avgHunterScore || 0
            };
            
            document.getElementById('totalUsers').textContent = safeStats.totalUsers;
            document.getElementById('verifiedEmails').textContent = safeStats.verifiedEmails;
            document.getElementById('todayRegistrations').textContent = safeStats.todayRegistrations;
            document.getElementById('avgHunterScore').textContent = `${safeStats.avgHunterScore}%`;
            
            log(LOG_LEVELS.DEBUG, 'Stats updated', { safeStats });
        }
        
        function displayUsers(users) {
            if (users.length === 0) {
                document.getElementById('usersTableContainer').innerHTML = `
                    <div class="empty-state">
                        <div>üì≠</div>
                        <p>No users found</p>
                    </div>
                `;
                return;
            }
            
            const tableHTML = `
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Hunter Score</th>
                                <th>Registration Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map(user => `
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="user-avatar me-2">${user.firstName.charAt(0)}${user.lastName.charAt(0)}</div>
                                            <div>
                                                <div class="fw-medium">${user.firstName} ${user.lastName}</div>
                                                <small class="text-muted">ID: ${user.id}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>${user.email}</td>
                                    <td>
                                        <span class="status-badge ${user.emailVerified ? 'status-verified' : 'status-pending'}">
                                            ${user.emailVerified ? 'Verified' : 'Pending'}
                                        </span>
                                    </td>
                                    <td>${user.hunterScore ? user.hunterScore.toFixed(1) : 0}%</td>
                                    <td>${new Date(user.registrationDate).toLocaleDateString()}<br><small class="text-muted">${new Date(user.registrationDate).toLocaleTimeString()}</small></td>
                                    <td>
                                        <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.id}', '${user.firstName} ${user.lastName}')">
                                            <i class="bi bi-trash"></i> Delete
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('usersTableContainer').innerHTML = tableHTML;
        }
        
        async function deleteUser(userId, userName) {
            if (!confirm(`Are you sure you want to delete user "${userName}"? This action cannot be undone.`)) {
                return;
            }
            
            try {
                log(LOG_LEVELS.INFO, 'Attempting to delete user', { userId, userName });
                
                const response = await fetch(`https://legal-forensics-api-dev-vish.hebbarvcorning.workers.dev/api/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    log(LOG_LEVELS.INFO, 'User deleted successfully', { userId, userName });
                    alert(`User "${userName}" has been deleted successfully.`);
                    
                    // Reload the users list
                    loadUsers();
                } else {
                    const errorData = await response.json();
                    log(LOG_LEVELS.ERROR, 'Failed to delete user', { 
                        userId, 
                        userName, 
                        status: response.status, 
                        error: errorData.error 
                    });
                    alert(`Failed to delete user: ${errorData.error || 'Unknown error'}`);
                }
                
            } catch (error) {
                log(LOG_LEVELS.ERROR, 'Error deleting user', { 
                    userId, 
                    userName, 
                    error: error.message 
                });
                alert(`Error deleting user: ${error.message}`);
            }
        }
        
        function filterUsers() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            log(LOG_LEVELS.DEBUG, 'Filtering users', { searchTerm });
            
            // Implement client-side filtering or reload with search parameter
            if (searchTerm.length > 2) {
                loadUsersWithSearch(searchTerm);
            } else if (searchTerm.length === 0) {
                loadUsers();
            }
        }
        
        async function loadUsersWithSearch(searchTerm) {
            try {
                                                                   const response = await fetch(`https://legal-forensics-api-dev-vish.hebbarvcorning.workers.dev/api/users?search=${encodeURIComponent(searchTerm)}`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        displayUsers(data.data.users);
                    }
                }
            } catch (error) {
                log(LOG_LEVELS.ERROR, 'Search failed', { error: error.message, searchTerm });
            }
        }
        
        async function downloadCSV() {
            try {
                log(LOG_LEVELS.INFO, 'CSV download initiated');
                
                                                                   const response = await fetch('https://legal-forensics-api-dev-vish.hebbarvcorning.workers.dev/api/download-csv');
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `legal_forensics_users_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                log(LOG_LEVELS.INFO, 'CSV download completed');
                
            } catch (error) {
                log(LOG_LEVELS.ERROR, 'CSV download failed', { 
                    error: error.message,
                    stack: error.stack
                });
                
                // Check if it's a KV namespace error
                if (error.message.includes('Database not configured')) {
                    alert('CSV download failed: Database not configured. Please set up KV namespace LF_USERS_DATA in Cloudflare Dashboard.');
                } else {
                    alert('Failed to download CSV: ' + error.message);
                }
            }
        }
        
        function addUser() {
            log(LOG_LEVELS.INFO, 'Add user function called');
            alert('Add user functionality not implemented yet.');
        }
        
        // Enhanced initialization
        document.addEventListener('DOMContentLoaded', function() {
            log(LOG_LEVELS.INFO, 'Admin panel initialized', { 
                userAgent: navigator.userAgent,
                timestamp: new Date().toISOString()
            });
            
            // Check for existing session
            if (validateSession()) {
                log(LOG_LEVELS.INFO, 'Valid session found, auto-authenticating');
                document.getElementById('authOverlay').style.display = 'none';
                document.getElementById('dashboardContainer').style.display = 'block';
                loadUsers();
            } else {
                log(LOG_LEVELS.INFO, 'No valid session, showing login');
            }
            
            // Session expiry check every minute
            setInterval(() => {
                if (!validateSession()) {
                    log(LOG_LEVELS.WARN, 'Session expired during use, logging out');
                    logout();
                }
            }, 60000);
        });
        
        // Enhanced error handling
        window.addEventListener('error', function(e) {
            log(LOG_LEVELS.ERROR, 'JavaScript error', { 
                message: e.message,
                filename: e.filename,
                lineno: e.lineno,
                colno: e.colno,
                stack: e.error?.stack
            });
        });
        
        window.addEventListener('unhandledrejection', function(e) {
            log(LOG_LEVELS.ERROR, 'Unhandled promise rejection', { 
                reason: e.reason,
                stack: e.reason?.stack
            });
        });
    </script>
</body>
</html>
